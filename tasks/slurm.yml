- name: Set SLURM conf facts for Debian
  set_fact: SBATCH_BINARY="/usr/local/bin/sbatch" SBATCH_BACKUP="/usr/local/bin/sbatch.o" CLUES_SBATCH_BINARY="/usr/local/bin/clues-slurm-wrapper"
  when: ansible_os_family == "Debian"

- name: Set SLURM conf facts for CentOS
  set_fact: SBATCH_BINARY="/usr/bin/sbatch" SBATCH_BACKUP="/usr/bin/sbatch.o" CLUES_SBATCH_BINARY="/usr/bin/clues-slurm-wrapper" SBATCH_BACKUP_DEBIAN="/usr/local/bin/sbatch.o"
  when: ansible_os_family == "RedHat"

- name: Set SLURM as CLUES2 LRMS
  ini_file: dest=/etc/clues2/clues2.cfg section=general option=LRMS_CLASS value=cluesplugins.slurm
  notify: restart cluesd

- name: Create SLURM plugin configuration file for CLUES2
  copy: src=/etc/clues2/conf.d/plugin-slurm.cfg-example dest=/etc/clues2/conf.d/plugin-slurm.cfg force=no
  notify: restart cluesd

- name: Set SLURM_SERVER value
  ini_file: dest=/etc/clues2/conf.d/plugin-slurm.cfg section=SLURM option=SLURM_SERVER value=slurmserver
  notify: restart cluesd

- name: Set SLURM specific config for CentOS
  ini_file: dest=/etc/clues2/conf.d/plugin-slurm.cfg section=SLURM option={{ item.option }} value="{{ item.value }}"
  notify: restart cluesd
  with_items:
    - { option: 'SLURM_PARTITION_COMMAND', value: '/usr/bin/scontrol -o show partitions' }
    - { option: 'SLURM_NODES_COMMAND', value: '/usr/bin/scontrol -o show nodes' }
    - { option: 'SLURM_JOBS_COMMAND', value: '/usr/bin/scontrol -o show jobs' }
  when: ansible_os_family == "RedHat"

- name: Create sbatch script backup
  command: mv {{SBATCH_BINARY}} {{SBATCH_BACKUP}} creates={{SBATCH_BACKUP}}

- name: Replace sbatch script with clues-slurm wrapper
  command: mv {{CLUES_SBATCH_BINARY}} {{SBATCH_BINARY}} creates={{SBATCH_BINARY}}

- name: Create simbolic link
  file: src={{SBATCH_BACKUP}} dest={{SBATCH_BACKUP_DEBIAN}} state=link
  when: ansible_os_family == "RedHat"
